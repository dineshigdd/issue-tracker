
<!doctype html>
<html>
<head>
    <title>Issue tracker login</title>

    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles/styles.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
<div>
    <form method="post" action='/project'>      
        
            <label>username</label><input id="email" type="email" name="email"/>
            <label>password</label><input id="password" type="password" name="password"/>
            <button id="submit">submit</button>
       
    </form>
    <script>
        const requestToken = (userData) =>{           
                 axios.post('/api/users/login', userData)
                    .then( response => {
                        // const addedUser = response.data;
                        const{ token, project } = response.data;
                        console.log("POST: user is added", token);  
                        localStorage.setItem('jwtToken', token);
                        setAuthToken(token);
                        // getUserProjects(token)
                        // const decoded = parseJwt(token);
                       
                        // axios.get('api/projects/my-project')
                        // document.location = project;
                        
                        
                    }).catch(error => console.log(error))
            
        }

        const getUserProjects = (token) => {
            // console.log("test:" + localStorage.getItem('jwtToken'));
            axios.get('api/projects/my-project/',{
                headers:{
                    'Authorization': token
                }
            })
            .then(function (response) {
                   
                    document.body.innerHTML= response.data;
                          
                    
                   
                })
                .catch(function (error) {
                    console.log(error);
                });;
                
        }
        const form = document.querySelector('form');

            const formEvent = form.addEventListener('submit', event => {
            event.preventDefault();

            const email = document.querySelector('#email').value;
            const password = document.querySelector('#password').value;

            const user = { email, password };
            requestToken(user);
            getUserProjects(localStorage.getItem('jwtToken'))
        })


        const setAuthToken = (token) => {
           
            if( token ){
                axios.defaults.headers.common['Authorization'] = token;
               
            } else{
                delete axios.defaults.headers.common['Authorization'] 
            }
         
        };


        // const isLoggedIn = () => {
        //     const token =  localStorage.getItem('jwtToken');
        //     if( !token ){
        //         return false;
        //     }
        // }

        // const redirect = () =>{
        //     const isLogged = isLoggedIn();

        //     if( isLogged ){
        //         axio.get('/project');
        //     }
        // }
        // function parseJwt (token) {
        //     var base64Url = token.split('.')[1];
        //     var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        //     var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        //         return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        //     }).join(''));

        //     return JSON.parse(jsonPayload);
        // };
    </script>
</div>
</body>
</html>
